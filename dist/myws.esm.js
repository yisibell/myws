import e from"mitt";var n="ws_reconnect",o=function(o){var r=o.heart_interval,s=void 0===r?5e4:r,t=o.api,c=o.open,a=o.ws_bus_emit_names||{onopen:"ws_open",onmessage:"ws_message",onerror:"ws_error",onclose:"ws_close"},i=e(),l=null,m=!0;try{m="string"==typeof c?JSON.parse(c):c}catch(e){m=!0,console.error("the open property should be a truly value.")}if(m&&t){var u=new WebSocket(t);return u.onopen=function(e){console.log("ws connected..."),i.emit(a.onopen,e),o.onopen&&o.onopen(e),u.send("heart"),clearInterval(l),l=setInterval((function(){u.send("heart")}),"string"==typeof s?Number.parseInt(s):s)},u.onmessage=function(e){var n=JSON.parse(e.data);i.emit(a.onmessage,n),o.onmessage&&o.onmessage(n)},u.onerror=function(e){console.log("ws error!"),i.emit(a.onerror,e),clearInterval(l),o.onerror&&o.onerror(e)},u.onclose=function(e){console.log("ws closed!"),function(e,o){e.emit(n,o)}(i,e),i.emit(a.onclose,e),clearInterval(l),o.onclose&&o.onclose(e)},{WS:u,WsBus:i}}return{WsBus:i}},r=0,s=function(e,t){e.ws_bus_emit_names=Object.assign({onopen:"ws_open",onmessage:"ws_message",onerror:"ws_error",onclose:"ws_close"},e.ws_bus_emit_names);var c=o(e);if(c){var a=c.WsBus,i=e.reconnect_limit,l=void 0===i?30:i,m=e.reconnect_limit_msg,u=e.reconnect_msg;return a.on(e.ws_bus_emit_names.onopen,(function(){var e;void 0===(e=0)&&(e=0),r=e})),a.on(n,(function(){if(r>l){var n=m||"The number of ws reconnections has exceeded ".concat(l,"ï¼Œyou can refresh to reconnect the ws server!");console.warn(n)}else setTimeout((function(){++r;var n="ws reconnect the ".concat(r,"th time ...");"function"==typeof u?n=u(r):u&&(n=u),console.log(n),s(e,t)}),e.reconnect_interval||3e3)})),t(c),c}},t={install:function(e,n){void 0===n&&(n={}),s(n,(function(n){e.prototype.$ws=n}))}};export{r as WS_CONNECT_COUNT,o as createWebSocket,s as initMyws,t as wsInstaller};
