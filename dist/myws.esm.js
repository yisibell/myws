import e from"mitt";var o="ws_reconnect",n=function(n){var r=n.heart_interval,s=void 0===r?5e4:r,t=n.api,c=n.open,a=n.ws_bus_emit_names||{onopen:"ws_open",onmessage:"ws_message",onerror:"ws_error",onclose:"ws_close"},i=e(),l=null,m=!0;try{m="string"==typeof c?JSON.parse(c):c}catch(e){m=!0,console.error("the open property should be a truly value.")}if(m&&t){var u=new WebSocket(t,n.protocols);return u.onopen=function(e){console.log("ws connected..."),i.emit(a.onopen,e),n.onopen&&n.onopen(e),u.send("heart"),clearInterval(l),l=setInterval((function(){u.send("heart")}),"string"==typeof s?Number.parseInt(s):s)},u.onmessage=function(e){var o=JSON.parse(e.data);i.emit(a.onmessage,o),n.onmessage&&n.onmessage(o)},u.onerror=function(e){console.log("ws error!"),i.emit(a.onerror,e),clearInterval(l),n.onerror&&n.onerror(e)},u.onclose=function(e){console.log("ws closed!"),function(e,n){e.emit(o,n)}(i,e),i.emit(a.onclose,e),clearInterval(l),n.onclose&&n.onclose(e)},{WS:u,WsBus:i}}return{WsBus:i}},r=0,s=function(e,t){e.ws_bus_emit_names=Object.assign({onopen:"ws_open",onmessage:"ws_message",onerror:"ws_error",onclose:"ws_close"},e.ws_bus_emit_names);var c=n(e);if(c){var a=c.WsBus,i=e.reconnect_limit,l=void 0===i?30:i,m=e.reconnect_limit_msg,u=e.reconnect_msg;return a.on(e.ws_bus_emit_names.onopen,(function(){var e;void 0===(e=0)&&(e=0),r=e})),a.on(o,(function(){if(r>l){var o=m||"The number of ws reconnections has exceeded ".concat(l,"ï¼Œyou can refresh to reconnect the ws server!");console.warn(o)}else setTimeout((function(){++r;var o="ws reconnect the ".concat(r,"th time ...");"function"==typeof u?o=u(r):u&&(o=u),console.log(o),s(e,t)}),e.reconnect_interval||3e3)})),t(c),c}},t={install:function(e,o){void 0===o&&(o={}),s(o,(function(o){e.prototype.$ws=o}))}};export{r as WS_CONNECT_COUNT,n as createWebSocket,s as initMyws,t as wsInstaller};
